<!DOCTYPE html>
<!-- Built on Frappe. https://frappe.io/ -->
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="generator" content="frappe">

	{% block meta_block %}
	{% include "templates/includes/meta_block.html" %}
	{% endblock %}

	<title>{% block title %}{{ title | striptags }}{% endblock %}</title>

	{% block favicon %}
	<link rel="shortcut icon" href="{{ (favicon or " /assets/frappe/images/favicon.png") | abs_url }}"
		type="image/x-icon">
	{% endblock %}

	<link rel="canonical" href="{{ canonical }}">

	{%- block head -%}
	{% if head_html is defined -%}
	{{ head_html or "" }}
	{%- endif %}

	{% if theme.theme_url %}
	<link type="text/css" rel="stylesheet" href="{{ theme.theme_url }}">
	{% else %}
	<link type="text/css" rel="stylesheet" href="/assets/css/frappe-web-b4.css">

	{%- for link in web_include_css %}
	<link type="text/css" rel="stylesheet" href="{{ link|abs_url }}">
	{%- endfor -%}
	{% endif %}
	{%- endblock -%}

	{%- block head_include %}
	{{ head_include or "" }}
	{% endblock -%}

	{%- block style %}{%- endblock -%}

	<script>
		window.frappe = {};
		frappe.ready_events = [];
		frappe.ready = function (fn) {
			frappe.ready_events.push(fn);
		}
		window.dev_server = {{ dev_server }};
		window.socketio_port = {{ (frappe.socketio_port or 'null') }};
    </script>

	<script type="text/javascript">
		// Utility function to check if an object is empty
		function isEmpty(obj) {
			return obj && Object.keys(obj).length === 0 && obj.constructor === Object;
		}

		async function logCrudToMatomo(operationType, documentData, responseUrl) {
			const SITE_ID = '13';
			const MATOMO_URL = 'https://matomo.gourmetpakistan.com/matomo/matomo.php';
			const TOKEN_AUTH = 'b8504e7900cc62e160b32dd6409e6be6'; // Auth tokens = Log CRUD operations
			const DOC_DATA_CUSTOM_DIMENSION_ID = 1;

			const trackingData = {
				idsite: SITE_ID,
				rec: 1,
				apiv: 1,
				url: responseUrl,
				action_name: `API CALL: CRUD - ${operationType} - ${documentData.doctype} - ${documentData.name}`,
				rand: Math.random(),
				token_auth: TOKEN_AUTH,
				uid: frappe.session.user,
				// Comment e_* keys to log CRUD as Page View instead of Event
				e_c: `API CALL: CRUD`,
				e_a: `${operationType}`,
				e_n: `${documentData.doctype} - ${documentData.name}`,
				[`dimension${DOC_DATA_CUSTOM_DIMENSION_ID}`]: JSON.stringify(documentData)
			};

			const queryString = Object.entries(trackingData)
				.map(([key, value]) =>
					`${key}=${encodeURIComponent(value)}`
				).join('&');

			const trackingUrl = `${MATOMO_URL}?${queryString}`;

			try {
				await fetch(trackingUrl, { method: 'GET', mode: 'no-cors' });
				console.log(`Log to Matomo: API CALL: CRUD - ${operationType} - ${documentData.doctype} - ${documentData.name}`)
			} catch (error) {
				console.error('Error logging to Matomo:', error, trackingData);
			}

			return;
		}

		// Intercept XMLHttpRequest
		(function (open) {
			XMLHttpRequest.prototype.open = function (method, url, async, user, pass) {
				this.addEventListener('readystatechange', function () {
					if (this.readyState === 4) {

						const apiRequestsToExclude = [
							'socket.io'
						];
						const excludeApi = apiRequestsToExclude.some(apiRequest =>
							this.responseURL.includes(apiRequest)
						);

						try {
							if (!excludeApi) {
								// Validate response and parse JSON
								const validResponseJson = this.response !== "" ? this.response : null
								let documentData;
								if (validResponseJson) {
									const parsedResponse = JSON.parse(this.response);
									documentData = parsedResponse?.docs?.[0] ?? {};
									if (isEmpty(documentData)) {
										documentData = parsedResponse?.message ?? {};
									}
								}

								if (!isEmpty(documentData)) {
									let docLocalNameExists = false;
									if (documentData?.localname) {
										docLocalNameExists = true;
									}

									// Filter CRUD operations
									let isCrudOperation;
									if (this.responseURL.includes('client.insert') ||
										(this.responseURL.includes('save.savedocs') &&
											docLocalNameExists)
									) {
										isCrudOperation = 'CREATE';
									} else if (this.responseURL.includes('load.getdoc?')) {
										isCrudOperation = 'READ';
									} else if (
										this.responseURL.includes('save.savedocs') ||
										this.responseURL.includes('save.cancel') ||
										this.responseURL.includes('workflow.apply_workflow')
									) {
										isCrudOperation = 'UPDATE';
									}
									else if (this.responseURL.includes('client.delete')) {
										isCrudOperation = 'DELETE';

										const windowUrl = window.location.href;
										const requiredDocumentData = windowUrl.substring(
											windowUrl.indexOf('#Form/') + '#Form/'.length,
											windowUrl.length
										).split('/');

										documentData = {
											'doctype': requiredDocumentData[0],
											'name': requiredDocumentData[1]
										}
									}

									const excludeLogDoctype = ['Notification Settings'];

									if (isCrudOperation && !(documentData.doctype == null)) {
										if (!excludeLogDoctype.includes(documentData.doctype)) {
											logCrudToMatomo(isCrudOperation, documentData, this.responseURL);
										}
									}
								}
							}
						} catch (error) {
							console.error('Matomo - Error while capturing CRUD XMLHttpRequest', error);
						}
					}
				}, false);
				open.call(this, method, url, async, user, pass);
			};
		})(XMLHttpRequest.prototype.open);
	</script>

<!-- Matomo -->
	<script>
		window.onhashchange = function () {
		var userId = frappe.session.user;
		var _paq = window._paq = window._paq || [];
		/* tracker methods like "setCustomDimension" should be called before "trackPageView" */
		// _paq.push(['setCustomUrl', '/' + window.location.hash.substr(1)]);
		_paq.push(['setUserId', userId]);
		_paq.push(['setCustomUrl', window.location.href]);
		_paq.push(['trackPageView']);
		_paq.push(['enableLinkTracking']);
		(function () {
		var u = "//matomo.gourmetpakistan.com/matomo/";
		_paq.push(['setTrackerUrl', u + 'matomo.php']);
		_paq.push(['setSiteId', '13']);
		var d = document, g = d.createElement('script'), s = d.getElementsByTagName('script')[0];
		g.async = true; g.src = u + 'matomo.js'; s.parentNode.insertBefore(g, s);
		})();
		};
	</script>
<!-- End Matomo Code -->
</head>

<body frappe-session-status="{{ 'logged-in' if frappe.session.user != 'Guest' else 'logged-out'}}"
	data-path="{{ path | e }}" {%- if template and template.endswith('.md') %} frappe-content-type="markdown" {% endif
	-%}>
	{%- block banner -%}
	{% include "templates/includes/banner_extension.html" ignore missing %}

	{% if banner_html -%}
	{{ banner_html or "" }}
	{%- endif %}
	{%- endblock -%}

	{%- block navbar -%}
	{% include "templates/includes/navbar/navbar.html" %}
	{%- endblock -%}

	{% block content %}
	{{ content }}
	{% endblock %}

	{%- block footer -%}
	{% include "templates/includes/footer/footer.html" %}
	{%- endblock -%}

	{% block base_scripts %}
	<!-- js should be loaded in body! -->
	<script type="text/javascript" src="/assets/frappe/js/lib/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/js/frappe-web.min.js"></script>
	<script type="text/javascript" src="/assets/js/bootstrap-4-web.min.js"></script>
	{% endblock %}

	{%- for link in web_include_js %}
	<script type="text/javascript" src="{{ link | abs_url }}"></script>
	{%- endfor -%}

	{%- block script %}{%- endblock %}
	<!-- csrf_token -->
	{%- block body_include %}{{ body_include or "" }}{% endblock -%}
</body>

</html>
