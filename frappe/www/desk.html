<!DOCTYPE html>
<head>
	<!-- Chrome, Firefox OS and Opera -->
	<meta name="theme-color" content="#7575ff">
	<!-- Windows Phone -->
	<meta name="msapplication-navbutton-color" content="#7575ff">
	<!-- iOS Safari -->
	<meta name="apple-mobile-web-app-status-bar-style" content="#7575ff">	<meta charset="utf-8">
	<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8" http-equiv="encoding">
	<meta name="author" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1.0,
		maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, minimal-ui">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="white">
	<meta name="mobile-web-app-capable" content="yes">
	<title>Frappe Desk</title>
	<link rel="shortcut icon"
		href="{{ favicon or "/assets/frappe/images/favicon.png" }}" type="image/x-icon">
	<link rel="icon"
		href="{{ favicon or "/assets/frappe/images/favicon.png" }}" type="image/x-icon">
	{% for include in include_css -%}
	<link type="text/css" rel="stylesheet" href="{{ include }}?ver={{ build_version }}">
	{%- endfor -%}

	<script type="text/javascript">
		// Utility function to check if an object is empty
		function isEmpty(obj) {
			return obj && Object.keys(obj).length === 0 && obj.constructor === Object;
		}

		async function logCrudToMatomo(operationType, documentData, responseUrl) {
			const SITE_ID = '20';
			const MATOMO_URL = 'https://matomo.gourmetpakistan.com/matomo/matomo.php';
			const TOKEN_AUTH = 'b8504e7900cc62e160b32dd6409e6be6'; // Auth tokens = Log CRUD operations
			const DOC_DATA_CUSTOM_DIMENSION_ID = 1;

			const trackingData = {
				idsite: SITE_ID,
				rec: 1,
				apiv: 1,
				url: responseUrl,
				action_name: `API CALL: CRUD - ${operationType} - ${documentData.doctype} - ${documentData.name}`,
				rand: Math.random(),
				token_auth: TOKEN_AUTH,
				uid: frappe.session.user,
				// Comment e_* keys to log CRUD as Page View instead of Event
				e_c: `API CALL: CRUD`,
				e_a: `${operationType}`,
				e_n: `${documentData.doctype} - ${documentData.name}`,
				[`dimension${DOC_DATA_CUSTOM_DIMENSION_ID}`]: JSON.stringify(documentData)
			};

			const queryString = Object.entries(trackingData)
				.map(([key, value]) =>
					`${key}=${encodeURIComponent(value)}`
				).join('&');

			const trackingUrl = `${MATOMO_URL}?${queryString}`;

			try {
				await fetch(trackingUrl, { method: 'GET', mode: 'no-cors' });
				console.log(`Log to Matomo: API CALL: CRUD - ${operationType} - ${documentData.doctype} - ${documentData.name}`)
			} catch (error) {
				console.error('Error logging to Matomo:', error, trackingData);
			}

			return;
		}

		// Intercept XMLHttpRequest
		(function (open) {
			XMLHttpRequest.prototype.open = function (method, url, async, user, pass) {
				this.addEventListener('readystatechange', function () {
					if (this.readyState === 4) {

						const apiRequestsToExclude = [
							'socket.io'
						];
						const excludeApi = apiRequestsToExclude.some(apiRequest =>
							this.responseURL.includes(apiRequest)
						);

						try {
							if (!excludeApi) {
								// Validate response and parse JSON
								const validResponseJson = this.response !== "" ? this.response : null
								let documentData;
								if (validResponseJson) {
									const parsedResponse = JSON.parse(this.response);
									documentData = parsedResponse?.docs?.[0] ?? {};
									if (isEmpty(documentData)) {
										documentData = parsedResponse?.message ?? {};
									}
								}

								if (!isEmpty(documentData)) {
									let docLocalNameExists = false;
									if (documentData?.localname) {
										docLocalNameExists = true;
									}

									// Filter CRUD operations
									let isCrudOperation;
									if (this.responseURL.includes('client.insert') ||
										(this.responseURL.includes('save.savedocs') &&
											docLocalNameExists)
									) {
										isCrudOperation = 'CREATE';
									} else if (this.responseURL.includes('load.getdoc?')) {
										isCrudOperation = 'READ';
									} else if (
										this.responseURL.includes('save.savedocs') ||
										this.responseURL.includes('save.cancel') ||
										this.responseURL.includes('workflow.apply_workflow')
									) {
										isCrudOperation = 'UPDATE';
									}
									else if (this.responseURL.includes('client.delete')) {
										isCrudOperation = 'DELETE';

										const windowUrl = window.location.href;
										const requiredDocumentData = windowUrl.substring(
											windowUrl.indexOf('#Form/') + '#Form/'.length,
											windowUrl.length
										).split('/');

										documentData = {
											'doctype': requiredDocumentData[0],
											'name': requiredDocumentData[1]
										}
									}

									const excludeLogDoctype = ['Notification Settings'];

									if (isCrudOperation && !(documentData.doctype == null)) {
										if (!excludeLogDoctype.includes(documentData.doctype)) {
											logCrudToMatomo(isCrudOperation, documentData, this.responseURL);
										}
									}
								}
							}
						} catch (error) {
							console.error('Matomo - Error while capturing CRUD XMLHttpRequest', error);
						}
					}
				}, false);
				open.call(this, method, url, async, user, pass);
			};
		})(XMLHttpRequest.prototype.open);
	</script>

	<!-- Matomo -->
	<script>
		window.onhashchange = function () {
		var userId = frappe.session.user;
		var _paq = window._paq = window._paq || [];
		/* tracker methods like "setCustomDimension" should be called before "trackPageView" */
		// _paq.push(['setCustomUrl', '/' + window.location.hash.substr(1)]);
		_paq.push(['setUserId', userId]);
		_paq.push(['setCustomUrl', window.location.href]);
		_paq.push(['trackPageView']);
		_paq.push(['enableLinkTracking']);
		(function () {
		var u = "//matomo.gourmetpakistan.com/matomo/";
		_paq.push(['setTrackerUrl', u + 'matomo.php']);
		_paq.push(['setSiteId', '20']);
		var d = document, g = d.createElement('script'), s = d.getElementsByTagName('script')[0];
		g.async = true; g.src = u + 'matomo.js'; s.parentNode.insertBefore(g, s);
		})();
		};
	</script>
	<!-- End Matomo Code -->
</head>
<body>
	<div class="centered splash" style="width: 100px; height: 100px;">
        <img src="{{ splash_image or "/assets/frappe/images/frappe-framework-logo.png" }}">
    </div>
	<div class="main-section">
		<header></header>
		<div id="body_div"></div>
		<footer></footer>
	</div>

	<script type="text/javascript" src="/assets/frappe/js/lib/jquery/jquery.min.js"></script>

	<script type="text/javascript">
	window._version_number = "{{ build_version }}";
	// browser support
	window.app = true;
	window.dev_server = {{ dev_server }};

	if(!window.frappe) window.frappe = {};

	frappe.boot = {{ boot }};

	frappe.csrf_token = "{{ csrf_token }}";

	</script>

	{% for include in include_js %}
	<script type="text/javascript" src="{{ include }}?ver={{ build_version }}"></script>
	{% endfor %}
    {% include "templates/includes/app_analytics/google_analytics.html" %}
    {% include "templates/includes/app_analytics/mixpanel_analytics.html" %}

	{% for sound in (sounds or []) %}
	<audio preload="auto" id="sound-{{ sound.name }}" volume={{ sound.volume or 1 }}>
		<source src="{{ sound.src }}"></source>
	</audio>
	{% endfor %}
</body>
